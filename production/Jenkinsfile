pipeline {
    agent none

    stages {
        stage ('Build project - boxfuse') {
            agent {
                docker { 
                    image 'khvatea/java-builder:0.0.2'
                    // Set node builder for assembly
                    label 'builder'
                    args '-v /var/run/docker.sock:/var/run/docker.sock'
                    // Run the container on the node specified at the top-level of the Pipeline, in the same workspace, rather than on a new node entirely.
                    // Otherwise, dind will start not on the 'builder' node
                    reuseNode true
                }                
             }
             environment {
                PROD_PATH='$pwd'
             }
            stages {
                stage ('Clone git repository') {
                    steps {
                        git 'https://github.com/khvat-ea/boxfuse-origin-1.git'
                    }
                }
                stage ('Build java project') {
                    steps {
                        sh 'ls -la $pwd'
                        // sh 'mvn package'
                    }
                }
                stage ('Make docker image') {
                    steps {
                        sh 'ls -la $pwd'
                        dir ('prod'){
                            git branch: 'main', url: 'https://github.com/khvat-ea/les_11.git'
                        }
                        sh 'docker build --build-arg path_to_war="./target/hello-1.0.war" --file "./prod/production/Dockerfile" .'
                    }
                }
            }
        }
    }
}